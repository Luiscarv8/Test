DECLARE @EndDate DATE = (SELECT MAX(ProcessDate) from [MDR].[Reporting].[MDR_ProcessDates])
DECLARE @StartDate DATE = (SELECT ProcessDate+1 from (SELECT TOP 13 ProcessDate, RANK() OVER(ORDER BY ProcessDate DESC )  AS Rank from [MDR].[Reporting].[MDR_ProcessDates] ORDER BY ProcessDate DESC) x where Rank=13)

SELECT CAST(REFUND.REBATE_REQ_DATE as varchar(MAX))+'-'+CAST(TIME_STAMP as varchar(8))+'-'+OPERATOR REFUND_ID, BANK.BANK_NAME, REFUND.BANK_NUMBER
, 'IMD'+REFUND.BANK_NUMBER+RIGHT('0000000000'+REFUND.ACCOUNT_NUMBER,14) ADJ_ACCT_NBR
, BRANCH.BRANCH_NAME
, REFUND.OPERATOR
, RTRIM(EMPLOYEE.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE.NAME_LAST) OPERATOR_NAME
, RTRIM(EMPLOYEE.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE.NAME_LAST) + ' (' + REFUND.OPERATOR +')' OPERATOR_FULL
, REFUND.REBATE_REQ_DATE
, IIF(MONTH(REFUND.REBATE_REQ_DATE) < 10, '0'+CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(1)), CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(2))) REBATE_MONTH
, YEAR(REFUND.REBATE_REQ_DATE) REBATE_YEAR
, CAST(YEAR(REFUND.REBATE_REQ_DATE) as CHAR(4)) +'-' +  IIF(MONTH(REFUND.REBATE_REQ_DATE) < 10, '0'+CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(1)), CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(2))) REBATE_PERIOD
, REFUND.APPROVING_OPERATOR
, RTRIM(EMPLOYEE2.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE2.NAME_LAST) APP_OPERATOR_NAME
, IM.PRIM_OFFICER_NBR
, IM.OFFICER_NAME
, REFUND.CATEGORY
, REFUND.COMMENTS
, REFUND.TYPE
, REFUND.REASON
, REFUND.DATE_CHARGE_BEGIN
, REFUND.DATE_CHARGE_END
, REFUND.ACCOUNT_NUMBER
, REFUND.ACCOUNT_TITLE1
, REFUND.TOTAL_DEPOSIT
, REFUND.TOTAL_LOAN
, REFUND.AMOUNT

, BRANCH.BRANCH_NUMBER
, UPPER(IIF(BR.MARKET='No Market',BR.MARKET,REPLACE(BR.MARKET,'MARKET',''))) MARKET 
, UPPER(IIF(BR.REGION='No Region',BR.REGION,REPLACE(BR.REGION,'REGION',''))) REGION 
, REFUND.COMMENTS
, EMP_PAYROLL.LOB
FROM  
[ODS].[Reporting-SP].[ODS_SP_Refund] REFUND 
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Bank] BANK ON REFUND.BANK_NUMBER=BANK.BANK_NUMBER 
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Branch] BRANCH ON REFUND.BANK_NUMBER=BRANCH.BANK_NUMBER AND REFUND.BRANCH_NUMBER=BRANCH.BRANCH_NUMBER
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Employee] EMPLOYEE ON REFUND.OPERATOR=EMPLOYEE.OPERATOR_ID
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Employee] EMPLOYEE2 ON REFUND.APPROVING_OPERATOR=EMPLOYEE2.OPERATOR_ID  
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_BRANCH_REG] BRANCH_REGION ON REFUND.BANK_NUMBER=BRANCH_REGION.BANK_NUMBER 
	AND REFUND.BRANCH_NUMBER=BRANCH_REGION.BRANCH_NUMBER
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_EMP_Payroll] EMP_PAYROLL ON EMPLOYEE.PAYROLL_ID=EMP_PAYROLL.PAYROLL_ID
INNER JOIN [ODS].[Reporting].[ODS_Branch] BR on BR.BANK_NBR=REFUND.BANK_NUMBER AND BR.BRANCH_NBR=REFUND.BRANCH_NUMBER 
INNER JOIN [ODS].[Reporting].[ODS_IMpacs_DDA] IM on IM.ACCT_NBR=REFUND.ACCOUNT_NUMBER
WHERE APPLICATION = 'IM' AND REFUND.REBATE_REQ_DATE >= @StartDate 

UNION ALL

SELECT   CAST(REFUND.REBATE_REQ_DATE as varchar(MAX))+'-'+CAST(TIME_STAMP as varchar(8))+'-'+OPERATOR REFUND_ID, BANK.BANK_NAME, REFUND.BANK_NUMBER
, 'STM'+REFUND.BANK_NUMBER+RIGHT('0000000000'+REFUND.ACCOUNT_NUMBER,14) ADJ_ACCT_NBR
, BRANCH.BRANCH_NAME
, REFUND.OPERATOR
, RTRIM(EMPLOYEE.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE.NAME_LAST) OPERATOR_NAME
, RTRIM(EMPLOYEE.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE.NAME_LAST) + ' (' + REFUND.OPERATOR +')' OPERATOR_FULL
, REFUND.REBATE_REQ_DATE
, IIF(MONTH(REFUND.REBATE_REQ_DATE) < 10, '0'+CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(1)), CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(2))) REBATE_MONTH
, YEAR(REFUND.REBATE_REQ_DATE) REBATE_YEAR
, CAST(YEAR(REFUND.REBATE_REQ_DATE) as CHAR(4)) +'-' +  IIF(MONTH(REFUND.REBATE_REQ_DATE) < 10, '0'+CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(1)), CAST(MONTH(REFUND.REBATE_REQ_DATE) AS VARCHAR(2))) REBATE_PERIOD
, REFUND.APPROVING_OPERATOR
, RTRIM(EMPLOYEE2.NAME_FIRST) + ' ' + RTRIM(EMPLOYEE2.NAME_LAST) APP_OPERATOR_NAME
, ST.PRIM_OFFICER_NBR
, ST.OFFICER_NAME
, REFUND.CATEGORY
, REFUND.COMMENTS
, REFUND.TYPE
, REFUND.REASON
, REFUND.DATE_CHARGE_BEGIN
, REFUND.DATE_CHARGE_END
, REFUND.ACCOUNT_NUMBER
, REFUND.ACCOUNT_TITLE1
, REFUND.TOTAL_DEPOSIT
, REFUND.TOTAL_LOAN
, REFUND.AMOUNT

, BRANCH.BRANCH_NUMBER
, UPPER(IIF(BR.MARKET='No Market',BR.MARKET,REPLACE(BR.MARKET,'MARKET',''))) MARKET 
, UPPER(IIF(BR.REGION='No Region',BR.REGION,REPLACE(BR.REGION,'REGION',''))) REGION 
, REFUND.COMMENTS
, EMP_PAYROLL.LOB
FROM  
[ODS].[Reporting-SP].[ODS_SP_Refund] REFUND 
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Bank] BANK ON REFUND.BANK_NUMBER=BANK.BANK_NUMBER 
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Branch] BRANCH ON REFUND.BANK_NUMBER=BRANCH.BANK_NUMBER AND REFUND.BRANCH_NUMBER=BRANCH.BRANCH_NUMBER
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Employee] EMPLOYEE ON REFUND.OPERATOR=EMPLOYEE.OPERATOR_ID
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_Employee] EMPLOYEE2 ON REFUND.APPROVING_OPERATOR=EMPLOYEE2.OPERATOR_ID  
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_BRANCH_REG] BRANCH_REGION ON REFUND.BANK_NUMBER=BRANCH_REGION.BANK_NUMBER 
	AND REFUND.BRANCH_NUMBER=BRANCH_REGION.BRANCH_NUMBER
INNER JOIN [ODS].[Reporting-SP].[ODS_SP_EMP_Payroll] EMP_PAYROLL ON EMPLOYEE.PAYROLL_ID=EMP_PAYROLL.PAYROLL_ID
INNER JOIN [ODS].[Reporting].[ODS_Branch] BR on BR.BANK_NBR=REFUND.BANK_NUMBER AND BR.BRANCH_NBR=REFUND.BRANCH_NUMBER 
INNER JOIN [ODS].[Reporting].[ODS_SavingsTime] ST on ST.ACCT_NBR='0000'+REFUND.ACCOUNT_NUMBER
WHERE APPLICATION = 'ST' AND  REFUND.REBATE_REQ_DATE >= @StartDate 
